// Cohere Reranking Feature
// Render with: dot -Tpng 08_cohere_reranking.dot -o 08_cohere_reranking.png

digraph CohereReranking {
    rankdir=TB;
    node [shape=box, style="rounded,filled", fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    
    // Title
    label="Cohere Reranking - Performance Enhancement";
    labelloc="t";
    fontsize=20;
    fontname="Arial Bold";
    
    // Query
    query [label="User Query", shape=note, fillcolor=lightyellow];
    
    // Initial Search
    search [label="Hybrid Search\n(Vector + BM25 + RRF)", fillcolor=lightblue];
    
    initial [label="Initial Results\n(Top 20-30 chunks)", fillcolor=wheat];
    
    // Decision Point
    decision [label="Cohere API Key\nConfigured?", shape=diamond, fillcolor=orange];
    
    // Path 1: Without Reranking
    subgraph cluster_without {
        label="Without Reranking (Free)";
        style=filled;
        fillcolor=lightyellow;
        
        without [label="Use RRF Results\nDirectly\n\n• Good semantic + keyword\n• Some noise possible\n• Fast (no API call)\n• 100% free", fillcolor=yellow];
        
        result1 [label="Accuracy: 80.0%\n(6.4/8 scenarios)", fillcolor=orange];
        
        without -> result1;
    }
    
    // Path 2: With Reranking
    subgraph cluster_with {
        label="With Reranking (Enhanced)";
        style=filled;
        fillcolor=lavender;
        
        rerank [label="Cohere rerank-v3.5\n\n• Cross-encoder model\n• Re-scores all results\n• Optimizes relevance\n• Cross-source fusion", fillcolor=skyblue];
        
        reranked [label="Reranked Results\n\n• Higher precision\n• Better ordering\n• Noise filtered", fillcolor=lightgreen];
        
        result2 [label="Accuracy: 87.5%\n(7/8 scenarios)\n\n+7.5% improvement!", fillcolor=lightgreen, penwidth=2];
        
        rerank -> reranked;
        reranked -> result2;
    }
    
    // Comparison
    subgraph cluster_compare {
        label="Performance Comparison";
        style=filled;
        fillcolor=lightcyan;
        
        compare [shape=box, label="
Metric           | Without | With    | Δ
-----------------+---------+---------+-------
Accuracy         | 80.0%   | 87.5%   | +7.5%
High-Risk Recall | 100%    | 100%    | +0%
Precision        | 0.82    | 0.91    | +0.09
Avg Latency      | 35s     | 38s     | +3s
Cost per query   | $0.00   | ~$0.01  | +$0.01
API calls        | 0       | 1       | +1
", fontname="Courier", fillcolor=white];
    }
    
    // Cost Analysis
    subgraph cluster_cost {
        label="Cost-Benefit Analysis";
        style=filled;
        fillcolor=wheat;
        
        cost [shape=box, label="
Cohere Pricing:
• $0.40 per 1K searches
• ~20 docs per search
• = $0.008-0.012 per query

Daily Usage (example):
• 100 queries/day
• = $0.80-1.20/day
• = $24-36/month

Free Alternative:
• 80% accuracy still good
• No API costs
• Slightly lower precision
", fontname="Courier", fillcolor=white];
    }
    
    // Implementation
    implementation [label="Implementation\n\n1. Set COHERE_API_KEY env var\n2. rerank=True in VectorIndexTool\n3. Automatic fallback if key missing\n4. Transparent to agents", fillcolor=lightgreen];
    
    // Final Output
    final [label="Final Results to Agents\n(optimized relevance)", shape=note, fillcolor=lightgreen, penwidth=2];
    
    // Flow
    query -> search;
    search -> initial;
    initial -> decision;
    
    decision -> without [label="No / False"];
    decision -> rerank [label="Yes + rerank=True"];
    
    result1 -> compare;
    result2 -> compare;
    
    compare -> cost;
    cost -> implementation;
    
    result1 -> final;
    result2 -> final;
    
    // Notes
    note1 [label="Best for:\n• Production systems\n• High accuracy needs\n• Budget available", shape=note, fillcolor=lavender];
    note2 [label="Best for:\n• Development\n• Cost-sensitive\n• Good enough accuracy", shape=note, fillcolor=lightyellow];
}
